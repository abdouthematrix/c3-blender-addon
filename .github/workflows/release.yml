name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allows manual trigger

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Get version from tag
      id: get_version
      run: |
        if [ "${{ github.ref_type }}" = "tag" ]; then
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=v1.0.0-dev" >> $GITHUB_OUTPUT
        fi
    
    - name: Create add-on directory structure
      run: |
        mkdir -p c3_addon
        cp *.py c3_addon/ 2>/dev/null || true
        ls -la c3_addon/
    
    - name: Create release zip
      run: |
        zip -r c3-blender-addon-${{ steps.get_version.outputs.VERSION }}.zip c3_addon/
        ls -lh *.zip
    
    - name: Generate changelog
      id: changelog
      run: |
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        echo "## C3 Blender Add-On ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### Installation" >> $GITHUB_OUTPUT
        echo "1. Download the zip file below" >> $GITHUB_OUTPUT
        echo "2. In Blender: Edit > Preferences > Add-ons > Install" >> $GITHUB_OUTPUT
        echo "3. Select the downloaded zip file" >> $GITHUB_OUTPUT
        echo "4. Enable the add-on" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### Features" >> $GITHUB_OUTPUT
        echo "- Import C3 models (PHY, PHY3, PHY4)" >> $GITHUB_OUTPUT
        echo "- Animation support (XKEY, KKEY, ZKEY, Legacy)" >> $GITHUB_OUTPUT
        echo "- Shape key animation" >> $GITHUB_OUTPUT
        echo "- Automatic texture loading" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: c3-blender-addon-${{ steps.get_version.outputs.VERSION }}.zip
        body: ${{ steps.changelog.outputs.CHANGELOG }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload artifact (for manual runs)
      if: github.ref_type != 'tag'
      uses: actions/upload-artifact@v4
      with:
        name: c3-blender-addon
        path: c3-blender-addon-*.zip
