name: Create Release

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Allows manual trigger from GitHub Actions tab

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for version numbering
    
    - name: Get version
      id: get_version
      run: |
        # Get version from __init__.py or generate from commit
        VERSION=$(grep -oP "(?<=\"version\": \()\d+, \d+, \d+" __init__.py | tr -d ' ' | tr ',' '.')
        if [ -z "$VERSION" ]; then
          VERSION="1.0.0"
        fi
        
        # Add commit count for auto-incrementing build number
        COMMIT_COUNT=$(git rev-list --count HEAD)
        FULL_VERSION="v${VERSION}.${COMMIT_COUNT}"
        
        echo "VERSION=${FULL_VERSION}" >> $GITHUB_OUTPUT
        echo "Building version: ${FULL_VERSION}"
    
    - name: Create add-on directory structure
      run: |
        mkdir -p c3_addon
        cp *.py c3_addon/ 2>/dev/null || true
        ls -la c3_addon/
    
    - name: Create release zip
      run: |
        zip -r c3-blender-addon-${{ steps.get_version.outputs.VERSION }}.zip c3_addon/
        zip -r c3-blender-addon-latest.zip c3_addon/
        ls -lh *.zip
    
    - name: Generate changelog
      id: changelog
      run: |
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        echo "## C3 Blender Add-On ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "**Build Date:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### Installation" >> $GITHUB_OUTPUT
        echo "1. Download the zip file below" >> $GITHUB_OUTPUT
        echo "2. In Blender: Edit > Preferences > Add-ons > Install" >> $GITHUB_OUTPUT
        echo "3. Select the downloaded zip file" >> $GITHUB_OUTPUT
        echo "4. Enable the add-on" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### Features" >> $GITHUB_OUTPUT
        echo "- Import C3 models (PHY, PHY3, PHY4)" >> $GITHUB_OUTPUT
        echo "- Animation support (XKEY, KKEY, ZKEY, Legacy)" >> $GITHUB_OUTPUT
        echo "- Shape key animation" >> $GITHUB_OUTPUT
        echo "- Automatic texture loading" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### Recent Commits" >> $GITHUB_OUTPUT
        git log -5 --pretty=format:"- %s (%an)" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Delete old latest release
      continue-on-error: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Get the release ID of "latest" tag
        RELEASE_ID=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
          "https://api.github.com/repos/${{ github.repository }}/releases/tags/latest" \
          | jq -r '.id')
        
        if [ "$RELEASE_ID" != "null" ] && [ -n "$RELEASE_ID" ]; then
          echo "Deleting old release ID: $RELEASE_ID"
          curl -X DELETE -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID"
        fi
        
        # Delete the tag
        git push origin :refs/tags/latest 2>/dev/null || true
    
    - name: Create or Update Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: latest
        name: Latest Build - ${{ steps.get_version.outputs.VERSION }}
        body: ${{ steps.changelog.outputs.CHANGELOG }}
        files: |
          c3-blender-addon-${{ steps.get_version.outputs.VERSION }}.zip
          c3-blender-addon-latest.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: c3-blender-addon-${{ steps.get_version.outputs.VERSION }}
        path: c3-blender-addon-*.zip
        retention-days: 90